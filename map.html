<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFO ATC Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        #transcription {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 80%;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="transcription">
        <h3>Live ATC Transcription</h3>
        <div id="transcription-text">Waiting for ATC communications...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map centered at SFO
        const map = L.map('map').setView([37.6213, -122.3790], 13);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add a marker for SFO
        const sfoMarker = L.marker([37.6213, -122.3790])
            .addTo(map)
            .bindPopup('San Francisco International Airport (SFO)');

        // Function to fetch aircraft data from ADSB Exchange API
        async function fetchAircraftData() {
            const options = {
                method: 'GET',
                headers: {
                    'X-RapidAPI-Key': '1b2f83765emsh9ae964c7fe97f33p192f74jsn2ee826a525f0',
                    'X-RapidAPI-Host': 'adsbexchange-com1.p.rapidapi.com'
                }
            };

            try {
                const response = await fetch(`https://adsbexchange-com1.p.rapidapi.com/v2/lat/37.6213/lon/-122.3790/dist/1/`, options);
                const data = await response.json();
                updateAircraftMarkers(data);
            } catch (error) {
                console.error('Error fetching aircraft data:', error);
            }
        }

        // Store aircraft markers
        let aircraftMarkers = [];

        // Function to update aircraft markers on the map
        function updateAircraftMarkers(data) {
            // Clear existing markers
            aircraftMarkers.forEach(marker => marker.remove());
            aircraftMarkers = [];

            // Add new markers for each aircraft
            if (data.ac && Array.isArray(data.ac)) {
                data.ac.forEach(aircraft => {
                    if (aircraft.lat && aircraft.lon) {
                        // Create a custom airplane icon
                        const planeIcon = L.divIcon({
                            html: `<svg width="20" height="20" viewBox="0 0 24 24" style="transform: rotate(${aircraft.track || 0}deg)">
                                <path fill="#2196F3" d="M21,16V14L13,9V3.5A1.5,1.5,0,0,0,11.5,2A1.5,1.5,0,0,0,10,3.5V9L2,14V16L10,13.5V19L8,20.5V22L11.5,21L15,22V20.5L13,19V13.5L21,16Z"/>
                            </svg>`,
                            className: 'airplane-icon',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });

                        const marker = L.marker([aircraft.lat, aircraft.lon], {
                            icon: planeIcon
                        }).addTo(map);

                        // Create popup content with aircraft details
                        const popupContent = `
                            <strong>Flight:</strong> ${aircraft.flight || 'N/A'}<br>
                            <strong>Aircraft:</strong> ${aircraft.t || 'N/A'}<br>
                            <strong>Registration:</strong> ${aircraft.r || 'N/A'}<br>
                            <strong>Altitude:</strong> ${aircraft.alt_baro || 'Ground'}<br>
                            <strong>Speed:</strong> ${aircraft.gs || '0'} knots<br>
                            <strong>Heading:</strong> ${aircraft.track || 'N/A'}°
                        `;

                        marker.bindPopup(popupContent);
                        aircraftMarkers.push(marker);
                    }
                });
            }
        }

        // Function to update transcription text (to be connected with Python backend)
        function updateTranscription(text) {
            document.getElementById('transcription-text').innerText = text;
        }

        // Initial fetch of aircraft data
        fetchAircraftData();
    </script>
</body>
</html>